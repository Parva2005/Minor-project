<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Graph Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Color Palette */
            --bg-darkest: #0f172a;
            --bg-dark: #1e293b;
            --bg-medium: #334155;
            --bg-light: #475569;
            --bg-bright: #d7e8ff;
            --text-light: #e2e8f0;
            --text-dark: #0f172a;
            --accent-emerald: #10b981;
            --accent-cyan: #06b6d4;
            --accent-hover: #059669;

            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 2.5rem;
            --spacing-3xl: 3rem;

            /* Font Sizes (rem based for accessibility) */
            --font-size-base: 0.9rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;

            /* Border Radius */
            --radius-md: 0.5rem;
            --radius-lg: 1rem;
            --radius-full: 9999px;

            /* Box Shadow */
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            font-size: var(--font-size-base);
            background-color: var(--bg-darkest);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .container {
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100%;
        }

        .header {
            background-color: var(--bg-dark);
            padding: var(--spacing-sm) var(--spacing-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .header-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            background-image: linear-gradient(to right, var(--accent-emerald), var(--accent-cyan));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .new-chat-btn {
            background-color: var(--bg-medium);
            color: var(--text-light);
            font-weight: 600;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            transition-property: background-color;
            transition-duration: 150ms;
            border: none;
        }

        .new-chat-btn:hover {
            background-color: var(--bg-light);
        }

        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 12rem;
            /* background-color: var(--bg-dark); */
            padding: var(--spacing-md);
            border: 1px solid var(--bg-medium);
            overflow-y: auto;
            margin: 24px;
            border-radius: 16px;
        }

        @media (max-width: 767px) {
            .sidebar {
                display: none;
            }
        }

        .chat-list-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }

        .chat-list-item {
            width: 100%;
            text-align: left;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            background-color: var(--bg-medium);
            transition-property: background-color;
            transition-duration: 150ms;
        }

        .chat-list-item:hover {
            background-color: var(--bg-light);
        }

        .main-chat-area {
            flex: 1;
            display: flex;
            flex-direction: row; /* two columns: chat + preview */
            gap: var(--spacing-lg);
            overflow: hidden;
            padding: var(--spacing-lg);
            padding-left: 0;
        }

        /* Chat column (left) - 1/3 width and scrollable */
        .chat-column {
            width: 33.333%;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            height: 100%;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto; /* only this column scrolls */
        }

        /* Preview column (right) - 2/3 width and does not scroll with the page */
        .preview-column {
            width: 66.666%;
            background-color: var(--bg-bright);
            border: 1px solid var(--bg-medium);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            /* gap: var(--spacing-sm); */
            overflow: hidden; /* preview column itself does not scroll */
        }

        .renderer-header {
            font-weight: 700;
            /* margin-bottom: var(--spacing-sm); */
            color: var(--text-dark);
            font-size: var(--font-size-lg);
        }

        .preview-content {
            width: 100%;
            height: calc(100% - 2rem);
            overflow: hidden; /* do not show a scrollbar for the preview column */
            background-color: transparent;
            /* padding: var(--spacing-sm); */
            border-radius: var(--radius-md);
            color: var(--text-dark);
        }

        .chat-history {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            overflow-y: auto;
        }

        .chat-message {
            display: flex;
            padding: var(--spacing-md);
            /* max-width: 48rem; */
            /* margin-left: 0.5rem; */
            /* margin-bottom: 0.5rem; */
            position: relative;
            padding-top: calc(var(--spacing-md) + 0.4rem);
        }

        .chat-message.user {
            /* width: calc(100% * 1 / 3); */
            background-color: var(--bg-light);
            align-self: flex-end;
            border-radius: var(--radius-md);
        }

        .chat-message.ai {
            /* width: calc(100% * 1 / 3); */
            background-color: var(--bg-medium);
            align-self: flex-start;
            border-radius: var(--radius-md);
        }
        
        .ai-graph-container {
            width: calc(100% * 2 / 3);
            padding: var(--spacing-md);
            background-color: var(--bg-light);
            border-radius: var(--radius-lg);
        }

        /* small badge inside each message bubble indicating sender */
        .message-badge {
            position: absolute;
            left: 0.6rem;
            top: 0.4rem;
            font-size: 0.65rem;
            padding: 0.15rem 0.45rem;
            border-radius: 999px;
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .chat-message.ai .message-badge { background: var(--bg-medium); color: var(--accent-emerald); }
        .chat-message.user .message-badge { background: var(--bg-light); color: var(--accent-cyan); }

        .message-content { display: block; width: 100%; }

        .mermaid-container > svg {
            display: block;
            width: 100%;
            height: 100%;
        }

        .input-wrapper {
            display: flex;
            /* width: 80%; */
            margin: 0 4px;
            gap: var(--spacing-sm);
            align-items: center;
            position: sticky;
            bottom: 0;
            padding-bottom: 4px;
            padding-top: var(--spacing-md);
        }

        .chat-input {
            flex-grow: 1;
            padding: var(--spacing-md);
            background-color: var(--bg-dark);
            border-radius: var(--radius-md);
            border: 1px solid var(--bg-medium);
            color: var(--text-light);
            transition-property: all;
            transition-duration: 150ms;
            font-size: var(--font-size-base);
        }

        .chat-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-emerald);
        }

        .send-btn {
            background-color: var(--accent-emerald);
            color: var(--text-dark);
            font-weight: 600;
            padding: var(--spacing-md) var(--spacing-2xl);
            border-radius: var(--radius-md);
            transition-property: all;
            transition-duration: 150ms;
            box-shadow: var(--shadow-lg);
            border: none;
            height: 100%;
        }

        .send-btn:hover {
            background-color: var(--accent-hover);
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }

        @keyframes dots {
            to {
                content: '...';
            }
        }

        #chat-history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .chat-list-item {
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-light);
            font-size: var(--font-size-base);
            padding: var(--spacing-md) var(--spacing-md);
            text-align: left;
            background-color: var(--bg-medium);
            border-radius: var(--radius-md);
        }

    </style>
</head>

<body>

    <!-- Main Container -->
    <div class="container">

        <!-- Top Header -->
        <header class="header">
            <h1 class="header-title">
                GraphIt.AI
            </h1>
            <button id="new-chat-btn" class="new-chat-btn">
                New Chat +
            </button>
        </header>

        <!-- Main Content Area with Sidebar -->
        <div class="main-layout">

            <!-- Sidebar -->
            <aside class="sidebar">
                <h2 class="chat-list-title">Chat History</h2>
                <ul id="chat-history-list">
                    <!-- Chat titles will be added here dynamically -->
                </ul>
            </aside>

            <!-- Main Chat and Canvas View -->
            <main class="main-chat-area">

                <!-- Chat Column: 1/3 width, scrollable -->
                <section class="chat-column">
                    <div id="chat-history-main" class="chat-history">
                        <div class="chat-message ai">
                            <span class="message-badge">AI</span>
                            <div class="message-content"><p>Hello! I'm your AI assistant for Mermaid graphs. You can ask me to generate a graph from a description or explain a piece of Mermaid code. What can I help you with?</p></div>
                        </div>
                    </div>

                    <!-- Input Prompt Area (inside chat column) -->
                    <div class="input-wrapper">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Type your prompt...">
                        <button id="send-btn" class="send-btn">
                            Send
                        </button>
                    </div>
                </section>

                <!-- Preview Column: 2/3 width, non-scrolling -->
                <aside class="preview-column" aria-label="Graph preview column">
                    <div class="renderer-header">Preview</div>
                    <div id="preview-content" class="preview-content">
                        <!-- Mermaid render target will be injected here -->
                        <div id="preview-empty" style="color: var(--bg-medium); opacity: .8;">Rendered graph will appear here.</div>
                    </div>
                </aside>

            </main>
        </div>
    </div>

    <script type="module">
        // --- Core Application Logic ---

        const newChatBtn = document.getElementById('new-chat-btn');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatHistoryMain = document.getElementById('chat-history-main');
        const chatHistoryList = document.getElementById('chat-history-list');

        let currentChatId = null;
        let chatHistoryData = [];

        const newChat = () => {
            currentChatId = Date.now();
            chatHistoryData = [];
            chatHistoryMain.innerHTML = `<div class="chat-message ai"><span class="message-badge">AI</span><div class="message-content"><p>Hello! I'm your AI assistant for Mermaid graphs. You can ask me to generate a graph from a description or explain a piece of Mermaid code. What can I help you with?</p></div></div>`;
            updateChatHistoryList();
            chatInput.focus();
        };

        const updateChatHistoryList = () => {
            const chatTitle = "New Chat";
            const listItem = document.createElement('li');
            listItem.innerHTML = `<button class="chat-list-item">${chatTitle}</button>`;
            chatHistoryList.prepend(listItem);
        };

        const renderMessage = (message, sender, isGraph = false) => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message', sender);

            const badge = document.createElement('span');
            badge.classList.add('message-badge');
            badge.innerText = sender === 'ai' ? 'AI' : 'You';

            const content = document.createElement('div');
            content.classList.add('message-content');

            if (isGraph) {
                // For graph responses we render into the preview and show a caption in chat
                content.innerHTML = '<p>[Rendered graph preview updated]</p>';
                renderIntoPreview(message);
            } else {
                const p = document.createElement('p');
                p.innerText = message;
                content.appendChild(p);
            }

            messageElement.appendChild(badge);
            messageElement.appendChild(content);

            chatHistoryMain.appendChild(messageElement);
            chatHistoryMain.scrollTop = chatHistoryMain.scrollHeight;
        };

        const handleUserInput = async () => {
            const prompt = chatInput.value.trim();
            if (!prompt) return;

            renderMessage(prompt, 'user');
            chatInput.value = '';

            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('chat-message', 'ai', 'loading-dots');
            const loadingBadge = document.createElement('span');
            loadingBadge.classList.add('message-badge');
            loadingBadge.innerText = 'AI';
            const loadingContent = document.createElement('div');
            loadingContent.classList.add('message-content');
            loadingContent.innerText = 'Thinking';
            loadingMessage.appendChild(loadingBadge);
            loadingMessage.appendChild(loadingContent);
            chatHistoryMain.appendChild(loadingMessage);
            chatHistoryMain.scrollTop = chatHistoryMain.scrollHeight;

            let aiResponse = '';
            let isGraph = false;

            // Always request Mermaid code for any user prompt
            aiResponse = await generateMermaidCode(prompt);
            isGraph = true;

            loadingMessage.remove();

            if (aiResponse) {
                renderMessage(aiResponse, 'ai', isGraph);
            } else {
                renderMessage('I\'m sorry, I couldn\'t process that request.', 'ai');
            }
        };

        // Strip code fences and leading language identifiers (like ```mermaid) from model output
        const normalizeMermaid = (text) => {
            if (!text) return '';
            // Remove triple backticks and optional language label
            return text.replace(/^```(?:mermaid)?\s*/i, '').replace(/\s*```$/i, '').trim();
        };

        const renderIntoPreview = async (mermaidText) => {
            const preview = document.getElementById('preview-content');
            const previewEmpty = document.getElementById('preview-empty');
            previewEmpty && previewEmpty.remove();

            const code = normalizeMermaid(mermaidText);

            // Clear previous preview and create a container for mermaid
            preview.innerHTML = `<div id="preview-mermaid" class="mermaid-container">${code}</div>`;

            // Use mermaid to render into the container
            try {
                // mermaid.init will render any .mermaid elements
                mermaid.init(undefined, '#preview-mermaid');
            } catch (err) {
                preview.innerHTML = `<p style="color: var(--text-light);">Error rendering preview:<br>${err.message}</p>`;
            }
        };

        // --- Gemini API Calls (Simplified for local use) ---
        const callGeminiApi = async (systemPrompt, userQuery) => {
            const apiKey = "AIzaSyBazsMXQFqkFsD7R85ODywUtRL-MQcqO0w";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                console.error(`API error: ${response.status} ${response.statusText}`);
                return null;
            }

            const result = await response.json();
            return result?.candidates?.[0]?.content?.parts?.[0]?.text;
        };

        const generateMermaidCode = async (prompt) => {
            const systemPrompt = `You are a helpful assistant that generates Mermaid JS code. Respond only with the Mermaid code block and no other text. Your response must be in a single code block. The code block must start with "mermaid". Examples: "flowchart TD..." or "sequenceDiagram..." or "pie..." Do not include any explanation or additional text before or after the code block.`;
            const userQuery = `Generate Mermaid JS code for the following request: ${prompt}`;
            return await callGeminiApi(systemPrompt, userQuery);
        };

    // Non-graph conversational and explanation functions removed â€” only generateMermaidCode is used.
        
        // --- Event Listeners ---
        sendBtn.addEventListener('click', handleUserInput);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleUserInput();
            }
        });

        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
                handleUserInput();
            }
        });

        newChatBtn.addEventListener('click', newChat);

        // Initial setup
        newChat();

    </script>
</body>

</html>
